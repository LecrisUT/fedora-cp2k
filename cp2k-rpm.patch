diff -up cp2k-5.1/arch/Linux-x86-64-gfortran.popt.r cp2k-5.1/arch/Linux-x86-64-gfortran.popt
--- cp2k-5.1/arch/Linux-x86-64-gfortran.popt.r	2017-09-27 15:13:11.000000000 +0200
+++ cp2k-5.1/arch/Linux-x86-64-gfortran.popt	2017-11-07 00:49:00.319242156 +0100
@@ -1,8 +1,9 @@
 # Tested with: GFortran 6.4, MPICH 3.2, LAPACK 3.5.0, ScaLAPACK 2.0.2
 CC         = gcc
 CPP        =
-FC         = mpif90
-LD         = mpif90
+FC         = mpifort
+LD         = mpifort
+LD_SHARED  = mpifort -shared
 AR         = ar -r
 FFTW_INC   = $(GCC_DIR)/fftw/3.3-gnu/include
 FFTW_LIB   = $(GCC_DIR)/fftw/3.3-gnu/lib64
@@ -11,19 +12,25 @@ LIBINT_LIB = $(GCC_DIR)/libint/1.1.4-LAR
 LIBXC_INC  = $(GCC_DIR)/libxc/4.0.4-gnu/include
 LIBXC_LIB  = $(GCC_DIR)/libxc/4.0.4-gnu/lib64
 DFLAGS     = -D__FFTW3 -D__LIBINT -D__LIBXC -D__MPI_VERSION=3\
-             -D__LIBINT_MAX_AM=7 -D__LIBDERIV_MAX_AM1=6 -D__MAX_CONTR=4\
+             -D__LIBINT_MAX_AM=@LIBINT_MAX_AM@ -D__LIBDERIV_MAX_AM1=@LIBDERIV_MAX_AM@ -D__MAX_CONTR=4\
+             -D__SCALAPACK2 -D__ELPA=201705 @LIBSMM_DEFS@ -D__HAS_IEEE_EXCEPTIONS\
              -D__parallel -D__SCALAPACK
 CPPFLAGS   =
-FCFLAGS    = $(DFLAGS) -O2 -ffast-math -ffree-form -ffree-line-length-none\
+OPTFLAGS   = -O2 -ffast-math\
              -ftree-vectorize -funroll-loops\
              -mtune=native\
              -I$(FFTW_INC) -I$(LIBINT_INC) -I$(LIBXC_INC)
-LDFLAGS    = $(FCFLAGS) -static
-LIBS       = $(MPI_LIBRARY_PATH)/libscalapack-gnu.a\
-             $(LIBPATH)/liblapack-gnu.a\
-             $(LIBPATH)/libblas-gnu.a\
-             $(FFTW_LIB)/libfftw3.a\
-             $(LIBXC_LIB)/libxcf03.a\
-             $(LIBXC_LIB)/libxc.a\
-             $(LIBINT_LIB)/libderiv.a\
-             $(LIBINT_LIB)/libint.a
+CFLAGS     = $(DFLAGS) $(OPTFLAGS)
+CXXFLAGS   = $(DFLAGS) $(OPTFLAGS)
+FCFLAGS    = $(DFLAGS) $(OPTFLAGS) -ffree-form -ffree-line-length-none
+LDFLAGS    = $(FCFLAGS)
+LIBS       = -lelpa\
+             @LIBSMM_LIBS@\
+             -lscalapack -lmpiblacs -lstdc++\
+             -l@BLAS@\
+             -lfftw3\
+             -lxcf03\
+             -lxc\
+             -lderiv\
+             -lint
+DATA_DIR   = /usr/share/cp2k
diff -up cp2k-5.1/arch/Linux-x86-64-gfortran.psmp.r cp2k-5.1/arch/Linux-x86-64-gfortran.psmp
--- cp2k-5.1/arch/Linux-x86-64-gfortran.psmp.r	2017-09-27 15:13:11.000000000 +0200
+++ cp2k-5.1/arch/Linux-x86-64-gfortran.psmp	2017-11-07 00:49:05.379294401 +0100
@@ -1,8 +1,9 @@
 # Tested with: GFortran 6.4, MPICH 3.2, LAPACK 3.5.0, ScaLAPACK 2.0.2
 CC         = gcc
 CPP        =
-FC         = mpif90
-LD         = mpif90
+FC         = mpifort
+LD         = mpifort
+LD_SHARED  = mpifort -shared
 AR         = ar -r
 FFTW_INC   = $(GCC_DIR)/fftw/3.3-gnu/include
 FFTW_LIB   = $(GCC_DIR)/fftw/3.3-gnu/lib64
@@ -11,20 +12,26 @@ LIBINT_LIB = $(GCC_DIR)/libint/1.1.4-LAR
 LIBXC_INC  = $(GCC_DIR)/libxc/4.0.4-gnu/include
 LIBXC_LIB  = $(GCC_DIR)/libxc/4.0.4-gnu/lib64
 DFLAGS     = -D__FFTW3 -D__LIBINT -D__LIBXC -D__MPI_VERSION=3\
-             -D__LIBINT_MAX_AM=7 -D__LIBDERIV_MAX_AM1=6 -D__MAX_CONTR=4\
+             -D__LIBINT_MAX_AM=@LIBINT_MAX_AM@ -D__LIBDERIV_MAX_AM1=@LIBDERIV_MAX_AM@ -D__MAX_CONTR=4\
+             -D__SCALAPACK2 -D__ELPA=201705 @LIBSMM_DEFS@ -D__HAS_IEEE_EXCEPTIONS\
              -D__parallel -D__SCALAPACK
 CPPFLAGS   =
-FCFLAGS    = $(DFLAGS) -O2 -ffast-math -ffree-form -ffree-line-length-none\
+OPTFLAGS   = -O2 -ffast-math -ftree-vectorize -funroll-loops\
              -fopenmp -ftree-vectorize -funroll-loops\
              -mtune=native\
              -I$(FFTW_INC) -I$(LIBINT_INC) -I$(LIBXC_INC)
-LDFLAGS    = $(FCFLAGS) -static
-LIBS       = $(MPI_LIBRARY_PATH)/libscalapack-gnu.a\
-             $(LIBPATH)/liblapack-gnu.a\
-             $(LIBPATH)/libblas-gnu.a\
-             $(FFTW_LIB)/libfftw3.a\
-             $(FFTW_LIB)/libfftw3_threads.a\
-             $(LIBXC_LIB)/libxcf03.a\
-             $(LIBXC_LIB)/libxc.a\
-             $(LIBINT_LIB)/libderiv.a\
-             $(LIBINT_LIB)/libint.a
+CFLAGS     = $(DFLAGS) $(OPTFLAGS)
+CXXFLAGS   = $(DFLAGS) $(OPTFLAGS)
+FCFLAGS    = $(DFLAGS) $(OPTFLAGS) -fopenmp -ffree-form -ffree-line-length-none
+LDFLAGS    = $(FCFLAGS)
+LIBS       = -lelpa\
+             @LIBSMM_LIBS@\
+             -lscalapack -lmpiblacs -lstdc++\
+             -l@BLAS@\
+             -lfftw3\
+             -lfftw3_omp\
+             -lxcf03\
+             -lxc\
+             -lderiv\
+             -lint
+DATA_DIR   = /usr/share/cp2k
diff -up cp2k-5.1/arch/Linux-x86-64-gfortran.sopt.r cp2k-5.1/arch/Linux-x86-64-gfortran.sopt
--- cp2k-5.1/arch/Linux-x86-64-gfortran.sopt.r	2017-09-28 12:20:29.000000000 +0200
+++ cp2k-5.1/arch/Linux-x86-64-gfortran.sopt	2017-11-07 00:50:37.024240641 +0100
@@ -3,6 +3,7 @@ CC         = gcc
 CPP        =
 FC         = gfortran
 LD         = gfortran
+LD_SHARED  = gfortran -shared
 AR         = ar -r
 FFTW_INC   = $(GCC_DIR)/fftw/3.3-gnu/include
 FFTW_LIB   = $(GCC_DIR)/fftw/3.3-gnu/lib64
@@ -11,18 +12,22 @@ LIBINT_LIB = $(GCC_DIR)/libint/1.1.4-LAR
 LIBXC_INC  = $(GCC_DIR)/libxc/4.0.4-gnu/include
 LIBXC_LIB  = $(GCC_DIR)/libxc/4.0.4-gnu/lib64
 DFLAGS     = -D__FFTW3 -D__LIBINT -D__LIBXC\
-             -D__LIBINT_MAX_AM=7 -D__LIBDERIV_MAX_AM1=6 -D__MAX_CONTR=4
+             -D__HAS_IEEE_EXCEPTIONS @LIBSMM_DEFS@\
+             -D__LIBINT_MAX_AM=@LIBINT_MAX_AM@ -D__LIBDERIV_MAX_AM1=@LIBDERIV_MAX_AM@ -D__MAX_CONTR=4
 CPPFLAGS   = 
-FCFLAGS    = $(DFLAGS) -O2 -ffast-math -ffree-form -ffree-line-length-none\
+OPTFLAGS   = -O2 -ffast-math\
              -ftree-vectorize -funroll-loops\
              -mtune=native\
              -I$(FFTW_INC) -I$(LIBINT_INC) -I$(LIBXC_INC)
-LDFLAGS    = $(FCFLAGS) -static
-LIBS       = $(LIBPATH)/liblapack-gnu.a\
-             $(LIBPATH)/libblas-gnu.a\
-             $(FFTW_LIB)/libfftw3.a\
-             $(LIBXC_LIB)/libxcf03.a\
-             $(LIBXC_LIB)/libxc.a\
-             $(LIBINT_LIB)/libderiv.a\
-             $(LIBINT_LIB)/libint.a\
-             -lpthread
+CFLAGS     = $(DFLAGS) $(OPTFLAGS)
+CXXFLAGS   = $(DFLAGS) $(OPTFLAGS)
+FCFLAGS    = $(DFLAGS) $(OPTFLAGS) -ffree-form -ffree-line-length-none
+LDFLAGS    = $(FCFLAGS)
+LIBS       = -l@BLAS@\
+             @LIBSMM_LIBS@\
+             -lfftw3\
+             -lxcf03\
+             -lxc\
+             -lderiv\
+             -lint
+DATA_DIR   = /usr/share/cp2k
diff -up cp2k-5.1/arch/Linux-x86-64-gfortran.ssmp.r cp2k-5.1/arch/Linux-x86-64-gfortran.ssmp
--- cp2k-5.1/arch/Linux-x86-64-gfortran.ssmp.r	2017-09-28 12:20:29.000000000 +0200
+++ cp2k-5.1/arch/Linux-x86-64-gfortran.ssmp	2017-11-07 00:50:54.047416406 +0100
@@ -3,6 +3,7 @@ CC         = gcc
 CPP        =
 FC         = gfortran
 LD         = gfortran
+LD_SHARED  = gfortran -shared
 AR         = ar -r
 FFTW_INC   = $(GCC_DIR)/fftw/3.3-gnu/include
 FFTW_LIB   = $(GCC_DIR)/fftw/3.3-gnu/lib64
@@ -11,18 +12,23 @@ LIBINT_LIB = $(GCC_DIR)/libint/1.1.4-LAR
 LIBXC_INC  = $(GCC_DIR)/libxc/4.0.4-gnu/include
 LIBXC_LIB  = $(GCC_DIR)/libxc/4.0.4-gnu/lib64
 DFLAGS     = -D__FFTW3 -D__LIBINT -D__LIBXC\
-             -D__LIBINT_MAX_AM=7 -D__LIBDERIV_MAX_AM1=6 -D__MAX_CONTR=4
+             -D__HAS_IEEE_EXCEPTIONS @LIBSMM_DEFS@\
+             -D__LIBINT_MAX_AM=@LIBINT_MAX_AM@ -D__LIBDERIV_MAX_AM1=@LIBDERIV_MAX_AM@ -D__MAX_CONTR=4
 CPPFLAGS   = 
-FCFLAGS    = $(DFLAGS) -O2 -ffast-math -ffree-form -ffree-line-length-none\
+OPTFLAGS   = -O2 -ffast-math -ftree-vectorize\
              -fopenmp -ftree-vectorize -funroll-loops\
              -mtune=native\
              -I$(FFTW_INC) -I$(LIBINT_INC) -I$(LIBXC_INC)
-LDFLAGS    = $(FCFLAGS) -static
-LIBS       = $(LIBPATH)/liblapack-gnu.a\
-             $(LIBPATH)/libblas-gnu.a\
-             $(FFTW_LIB)/libfftw3.a\
-             $(FFTW_LIB)/libfftw3_threads.a\
-             $(LIBXC_LIB)/libxcf03.a\
-             $(LIBXC_LIB)/libxc.a\
-             $(LIBINT_LIB)/libderiv.a\
-             $(LIBINT_LIB)/libint.a
+CFLAGS     = $(DFLAGS) $(OPTFLAGS)
+CXXFLAGS   = $(DFLAGS) $(OPTFLAGS)
+FCFLAGS    = $(DFLAGS) $(OPTFLAGS) -fopenmp -ffree-form -ffree-line-length-none
+LDFLAGS    = $(FCFLAGS)
+LIBS       = -l@BLAS@\
+             @LIBSMM_LIBS@\
+             -lfftw3\
+             -lfftw3_omp\
+             -lxcf03\
+             -lxc\
+             -lderiv\
+             -lint
+DATA_DIR   = /usr/share/cp2k
diff -up cp2k-5.1/tools/regtesting/do_regtest.r cp2k-5.1/tools/regtesting/do_regtest
--- cp2k-5.1/tools/regtesting/do_regtest.r	2017-01-20 11:58:56.000000000 +0100
+++ cp2k-5.1/tools/regtesting/do_regtest	2017-11-07 00:24:03.884859916 +0100
@@ -247,8 +247,8 @@ cp2k_postfix=${cp2k_postfix:-"${cp2k_run
 #
 ###################################################################################
 test_types_file=${dir_base}/${cp2k_dir}/tests/TEST_TYPES
-dir_last=${dir_base}/LAST-${dir_triplet}-${cp2k_version}
-dir_out=${dir_base}/TEST-${dir_triplet}-${cp2k_version}-${datum_short}
+dir_last=${dir_base}/${cp2k_dir}/LAST-${dir_triplet}-${cp2k_version}
+dir_out=${dir_base}/${cp2k_dir}/TEST-${dir_triplet}-${cp2k_version}-${datum_short}
 changelog=${dir_last}/ChangeLog
 changelog_diff=${changelog}.diff
 changelog_new=${changelog}.new
@@ -407,6 +407,7 @@ function run_regtest_dir() {
      test_tolerance=`grep -v "#" TEST_FILES | ${awk} -v itest=$itest -v def_err_tol=$default_err_tolerance '{c=c+1;if (c==itest) if (NF >= 3) { print $3 } else { print def_err_tol } }'`
      test_ref_value=`grep -v "#" TEST_FILES | ${awk} -v itest=$itest '{c=c+1;if (c==itest) if (NF == 4) { print $4 } }'`
 
+     echo "Running ${input_file}"
      output_file=${dir_out}/${dir}/${input_file}.out
      output_last=${dir_last}/${dir}/${input_file}.out
 
